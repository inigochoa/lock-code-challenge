---
import type { Frontmatter } from '@/types/site'
import BaseLayout from '@/layouts/BaseLayout.astro'
import Header from '@/components/Header.astro'
import Clue from '@/components/Clue.astro'
import Display from '@/components/Display.astro'
import Pad from '@/components/Pad.astro'
import Footer from '@/components/Footer.astro'
import Dialog from '@/components/Dialog.astro'
import { t } from '@/i18n/utils'
import { site } from '@/data/site'

const frontmatter: Frontmatter = {
  description: t('index.description'),
  title: t('index.title'),
  schemas: ['site', 'game'],
}

const length = 3
---

<BaseLayout frontmatter={frontmatter}>
  <main class="h-full w-full" data-length={length}>
    <Header title={site.name} />

		<section class="container mx-auto">
      <Clue length={length} />

      <div class="bg-zinc-800 border-gray-500 border flex flex-col items-center justify-center m-auto p-4 relative rounded-md shadow-lg text-gray-500 w-80 z-50">
        <Display length={length} />
        <Pad />
      </div>

      <Footer site={site} />
		</section>

    <Dialog id="modal-help">
      <p class="font-bold mb-3 text-xl w-full">{t('dialog.title')}</p>
      <p class="mb-2" set:html={t('dialog.line1', { length })}></p>
      <p class="mb-2" set:html={t('dialog.line2')}></p>
      <p class="mb-2" set:html={t('dialog.line3')}></p>
      <p class="mb-2" set:html={t('dialog.line4')}></p>
    </Dialog>
	</main>
</BaseLayout>

<style>
  @reference "../styles/global.css";

  body.correct {
    @apply animate-body-correct;
  }

  body.wrong {
    @apply animate-body-wrong;
  }

  svg {
    @apply fill-zinc-800 h-9 w-9;
  }
</style>

<script>
  // ============================================================================
  // Constants & DOM Elements
  // ============================================================================
  const GAME_LENGTH = parseInt(document.querySelector('main')!.dataset.length!) || 3
  const HOVER_DURATION = 300
  const CLUE_ANIMATION_DURATION = 1000
  const STORAGE_KEYS = {
    STREAK: 'streak',
    HIGHSCORE: 'highscore',
  } as const

  // DOM Elements
  const body = document.querySelector('body')!
  const streak = document.getElementById('streak')!
  const highscore = document.getElementById('highscore')!
  const clueHider = document.getElementById('clue-hider')!
  const displayNumbers = document.querySelectorAll<HTMLElement>('.display-number')
  const numberClues = document.querySelectorAll<HTMLElement>('.clue-number')
  const padNumbers = document.querySelectorAll<HTMLElement>('.pad-number')
  const helpButton = document.getElementById('btn-help')!
  const restartButton = document.getElementById('btn-restart')!
  const helpModal = document.getElementById('modal-help') as HTMLDialogElement

  // ============================================================================
  // Game State
  // ============================================================================
  type GameState = {
    win: boolean
    ended: boolean
    displayNumbers: (number | undefined)[]
    lockNumbers: (number | undefined)[]
  }

  let state: GameState = {
    win: false,
    ended: false,
    displayNumbers: Array(GAME_LENGTH),
    lockNumbers: Array(GAME_LENGTH),
  }

  // ============================================================================
  // Storage Helpers
  // ============================================================================
  const storage = {
    get: (key: string) => parseInt(localStorage.getItem(key) || '0'),
    set: (key: string, value: number) => localStorage.setItem(key, value.toString()),
  }

  // ============================================================================
  // UI Updates
  // ============================================================================
  function updateScoreDisplay(): void {
    streak.textContent = storage.get(STORAGE_KEYS.STREAK).toString()
    highscore.textContent = storage.get(STORAGE_KEYS.HIGHSCORE).toString()
  }

  function updateStreak(value: number): void {
    const currentHighscore = storage.get(STORAGE_KEYS.HIGHSCORE)
    const newHighscore = Math.max(value, currentHighscore)

    storage.set(STORAGE_KEYS.STREAK, value)
    storage.set(STORAGE_KEYS.HIGHSCORE, newHighscore)
    updateScoreDisplay()
  }

  function resetDisplay(): void {
    displayNumbers.forEach((el) => {
      el.textContent = ''
      el.classList.remove('filled', 'correct', 'wrong')
    })
    numberClues.forEach((el) => (el.textContent = ''))
  }

  function resetBodyClasses(): void {
    body.classList.remove('correct', 'wrong')
  }

  // ============================================================================
  // Game Logic
  // ============================================================================
  function getNextEmptyIndex(): number {
    return state.displayNumbers.findIndex((n) => n === undefined)
  }

  function addNumber(num: number): void {
    if (state.ended) return

    const index = getNextEmptyIndex()
    if (index === -1) return

    state.displayNumbers[index] = num

    const displayEl = document.querySelector<HTMLElement>(`#display-number-${index + 1}`)
    if (displayEl) {
      displayEl.textContent = num.toString()
      displayEl.classList.add('filled')
    }

    if (index + 1 === GAME_LENGTH) {
      checkAnswer()
    }
  }

  function checkAnswer(): void {
    state.ended = true
    clueHider.classList.add('show')

    const userCode = state.displayNumbers.join('')
    const lockCode = state.lockNumbers.join('')

    if (userCode === lockCode) {
      handleCorrectAnswer()
    } else {
      handleWrongAnswer()
    }
  }

  function handleCorrectAnswer(): void {
    state.win = true
    body.classList.add('correct')
    displayNumbers.forEach((el) => el.classList.add('correct'))

    const currentStreak = storage.get(STORAGE_KEYS.STREAK)
    updateStreak(currentStreak + 1)
  }

  function handleWrongAnswer(): void {
    body.classList.add('wrong')
    displayNumbers.forEach((el) => el.classList.add('wrong'))
    updateStreak(0)
  }

  function generateRandomCode(): void {
    for (let i = 0; i < GAME_LENGTH; i++) {
      const num = Math.floor(Math.random() * 10)
      state.lockNumbers[i] = num

      const clueEl = document.querySelector<HTMLElement>(`#clue-number-${i + 1}`)
      if (clueEl) clueEl.textContent = num.toString()
    }
  }

  function startGame(): void {
    state = {
      win: false,
      ended: false,
      displayNumbers: Array(GAME_LENGTH),
      lockNumbers: Array(GAME_LENGTH),
    }

    updateScoreDisplay()
    resetBodyClasses()
    resetDisplay()
    clueHider.classList.remove('show')

    // Animate random numbers for dramatic effect
    const interval = setInterval(generateRandomCode, 50)
    setTimeout(() => clearInterval(interval), CLUE_ANIMATION_DURATION)
  }

  function restartGame(): void {
    const currentStreak = storage.get(STORAGE_KEYS.STREAK)

    if (currentStreak > 0 && !state.win) {
      if (!confirm('Are you sure? You will lose your current streak')) {
        return
      }
      updateStreak(0)
    }

    startGame()
  }

  function showHelp(): void {
    helpModal.showModal()
  }

  // ============================================================================
  // Input Handlers
  // ============================================================================
  function triggerPadHover(num: number): void {
    const index = num === 0 ? 9 : num - 1
    const padEl = padNumbers[index]

    padEl.classList.add('hover')
    setTimeout(() => padEl.classList.remove('hover'), HOVER_DURATION)
  }

  function handleKeyboard(event: KeyboardEvent): void {
    if (event.ctrlKey) return

    const key = event.key.toLowerCase()

    // Numbers
    if (/^[0-9]$/.test(key)) {
      const num = parseInt(key)
      triggerPadHover(num)
      addNumber(num)
      return
    }

    // Commands
    if (key === 'h' || key === 'i') {
      showHelp()
    } else if (key === 'r' || key === 's' || key === ' ') {
      restartGame()
    }
  }

  // ============================================================================
  // Event Listeners
  // ============================================================================
  padNumbers.forEach((btn) => {
    btn.addEventListener('click', () => {
      const num = parseInt(btn.textContent || '0')
      addNumber(num)
    })
  })

  document.addEventListener('keydown', handleKeyboard)
  helpButton.addEventListener('click', showHelp)
  restartButton.addEventListener('click', restartGame)

  // ============================================================================
  // Initialize
  // ============================================================================
  showHelp()
  startGame()
</script>
